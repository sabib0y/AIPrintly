generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model assets {
  id                     String                   @id
  session_id             String
  user_id                String?
  source                 AssetSource
  asset_type             AssetType                @default(IMAGE)
  storage_key            String
  storage_url            String
  mime_type              String
  width                  Int
  height                 Int
  file_size              Int
  original_filename      String?
  metadata               Json                     @default("{}")
  created_at             DateTime                 @default(now())
  status                 AssetStatus              @default(TEMPORARY)
  storage_tier           StorageTier              @default(HOT)
  expires_at             DateTime?
  archived_at            DateTime?
  deleted_at             DateTime?
  last_accessed_at       DateTime?
  retention_days         Int                      @default(7)
  linked_to_order_id     String?
  sessions               sessions                 @relation(fields: [session_id], references: [id], onDelete: Cascade)
  users                  users?                   @relation(fields: [user_id], references: [id])
  product_configurations product_configurations[]
  storybook_projects     storybook_projects[]

  @@index([expires_at])
  @@index([session_id])
  @@index([status])
  @@index([storage_tier])
  @@index([user_id])
}

model auth_tokens {
  id         String        @id
  user_id    String?
  email      String
  token_hash String        @unique
  type       AuthTokenType
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime      @default(now())
  users      users?        @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model cart_items {
  id                     String                 @id
  session_id             String
  configuration_id       String
  quantity               Int                    @default(1)
  unit_price_pence       Int
  created_at             DateTime               @default(now())
  updated_at             DateTime
  product_configurations product_configurations @relation(fields: [configuration_id], references: [id], onDelete: Cascade)
  sessions               sessions               @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@unique([session_id, configuration_id])
  @@index([session_id])
}

model credit_transactions {
  id              String                  @id
  user_credits_id String
  amount          Int
  reason          CreditTransactionReason
  job_id          String?
  metadata        Json                    @default("{}")
  created_at      DateTime                @default(now())
  generation_jobs generation_jobs?        @relation(fields: [job_id], references: [id])
  user_credits    user_credits            @relation(fields: [user_credits_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([user_credits_id])
}

model fulfilment_events {
  id            String             @id
  order_item_id String
  provider      FulfilmentProvider
  event_type    String
  payload       Json
  processed     Boolean            @default(false)
  created_at    DateTime           @default(now())
  order_items   order_items        @relation(fields: [order_item_id], references: [id], onDelete: Cascade)

  @@index([order_item_id])
  @@index([processed])
}

model generation_jobs {
  id                  String                @id
  session_id          String
  type                GenerationJobType
  status              GenerationJobStatus   @default(PENDING)
  provider            String
  provider_job_id     String?
  input_params        Json                  @default("{}")
  output              Json?
  error_message       String?
  started_at          DateTime?
  completed_at        DateTime?
  created_at          DateTime              @default(now())
  credit_transactions credit_transactions[]
  sessions            sessions              @relation(fields: [session_id], references: [id], onDelete: Cascade)

  @@index([provider_job_id])
  @@index([session_id])
  @@index([status])
}

model order_items {
  id                     String                 @id
  order_id               String
  configuration_id       String
  product_name           String
  variant_name           String
  quantity               Int
  unit_price_pence       Int
  total_price_pence      Int
  fulfilment_provider    FulfilmentProvider
  fulfilment_order_id    String?
  fulfilment_status      FulfilmentStatus       @default(PENDING)
  tracking_number        String?
  tracking_url           String?
  created_at             DateTime               @default(now())
  updated_at             DateTime
  fulfilment_events      fulfilment_events[]
  product_configurations product_configurations @relation(fields: [configuration_id], references: [id])
  orders                 orders                 @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([fulfilment_order_id])
  @@index([order_id])
}

model orders {
  id                         String        @id
  order_number               String        @unique
  session_id                 String
  user_id                    String?
  status                     OrderStatus   @default(PENDING)
  subtotal_pence             Int
  shipping_pence             Int
  total_pence                Int
  currency                   String        @default("GBP")
  shipping_address           Json
  billing_address            Json?
  customer_email             String
  customer_name              String
  stripe_payment_intent_id   String?
  stripe_checkout_session_id String?
  tracking_token             String        @unique
  notes                      String?
  created_at                 DateTime      @default(now())
  updated_at                 DateTime
  order_items                order_items[]
  sessions                   sessions      @relation(fields: [session_id], references: [id])
  users                      users?        @relation(fields: [user_id], references: [id])

  @@index([status])
  @@index([user_id])
}

model product_configurations {
  id                 String              @id
  session_id         String
  product_id         String
  variant_id         String
  asset_id           String
  customisation      Json                @default("{}")
  mockup_url         String?
  created_at         DateTime            @default(now())
  updated_at         DateTime
  cart_items         cart_items[]
  order_items        order_items[]
  assets             assets              @relation(fields: [asset_id], references: [id])
  products           products            @relation(fields: [product_id], references: [id])
  sessions           sessions            @relation(fields: [session_id], references: [id], onDelete: Cascade)
  product_variants   product_variants    @relation(fields: [variant_id], references: [id])
  storybook_projects storybook_projects?

  @@index([product_id])
  @@index([session_id])
}

model product_variants {
  id                     String                   @id
  product_id             String
  external_id            String
  name                   String
  size                   String?
  colour                 String?
  colour_hex             String?
  base_price_pence       Int
  selling_price_pence    Int
  stock_status           StockStatus              @default(IN_STOCK)
  metadata               Json                     @default("{}")
  created_at             DateTime                 @default(now())
  product_configurations product_configurations[]
  products               products                 @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([product_id, external_id])
  @@index([product_id])
}

model products {
  id                     String                   @id
  external_id            String                   @unique
  provider               FulfilmentProvider
  category               ProductCategory
  name                   String
  description            String                   @default("")
  base_price_pence       Int
  selling_price_pence    Int
  is_active              Boolean                  @default(true)
  metadata               Json                     @default("{}")
  created_at             DateTime                 @default(now())
  updated_at             DateTime
  product_configurations product_configurations[]
  product_variants       product_variants[]

  @@index([category])
  @@index([is_active])
}

model sessions {
  id                     String                   @id
  user_id                String?
  session_token          String                   @unique
  expires_at             DateTime
  created_at             DateTime                 @default(now())
  assets                 assets[]
  cart_items             cart_items[]
  generation_jobs        generation_jobs[]
  orders                 orders[]
  product_configurations product_configurations[]
  users                  users?                   @relation(fields: [user_id], references: [id])
  user_credits           user_credits?

  @@index([user_id])
}

model storybook_projects {
  id                     String                 @id
  configuration_id       String                 @unique
  title                  String
  child_name             String
  child_age              Int?
  theme                  String
  page_count             Int
  pages                  Json                   @default("[]")
  cover_asset_id         String?
  pdf_url                String?
  created_at             DateTime               @default(now())
  updated_at             DateTime
  product_configurations product_configurations @relation(fields: [configuration_id], references: [id], onDelete: Cascade)
  assets                 assets?                @relation(fields: [cover_asset_id], references: [id])
}

model user_credits {
  id                  String                @id
  session_id          String?               @unique
  user_id             String?               @unique
  balance             Int                   @default(3)
  total_used          Int                   @default(0)
  created_at          DateTime              @default(now())
  updated_at          DateTime
  credit_transactions credit_transactions[]
  sessions            sessions?             @relation(fields: [session_id], references: [id], onDelete: Cascade)
  users               users?                @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model users {
  id            String        @id
  email         String        @unique
  password_hash String?
  created_at    DateTime      @default(now())
  updated_at    DateTime
  assets        assets[]
  auth_tokens   auth_tokens[]
  orders        orders[]
  sessions      sessions[]
  user_credits  user_credits?
}

enum AssetSource {
  UPLOAD
  GENERATED
}

enum AssetStatus {
  TEMPORARY
  SAVED
  IN_CART
  ORDERED
  ARCHIVED
}

enum AssetType {
  IMAGE
  STORY_PDF
  MOCKUP
}

enum AuthTokenType {
  MAGIC_LINK
  PASSWORD_RESET
}

enum CreditTransactionReason {
  INITIAL_GRANT
  SIGNUP_BONUS
  GENERATION
  REFUND
  PURCHASE
  ADMIN_ADJUSTMENT
}

enum FulfilmentProvider {
  PRINTFUL
  BLURB
}

enum FulfilmentStatus {
  PENDING
  SENT
  FULFILLED
  FAILED
}

enum GenerationJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum GenerationJobType {
  IMAGE
  STORY
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum ProductCategory {
  MUG
  APPAREL
  PRINT
  STORYBOOK
}

enum StockStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
}

enum StorageTier {
  HOT
  WARM
  COLD
  DELETED
}
